!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e()}(this,(function(){"use strict";var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};function e(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}var i=function(){return i=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},i.apply(this,arguments)};function s(t,e,i,s){return new(i||(i=Promise))((function(a,n){function r(t){try{h(s.next(t))}catch(t){n(t)}}function o(t){try{h(s.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?a(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,o)}h((s=s.apply(t,e||[])).next())}))}function a(t,e){var i,s,a,n,r={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return n={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(o){return function(h){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;n&&(n=0,o[0]&&(r=0)),r;)try{if(i=1,s&&(a=2&o[0]?s.return:o[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,o[1])).done)return a;switch(s=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return r.label++,{value:o[1],done:!1};case 5:r.label++,s=o[1],o=[0];continue;case 7:o=r.ops.pop(),r.trys.pop();continue;default:if(!(a=r.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){r=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){r.label=o[1];break}if(6===o[0]&&r.label<a[1]){r.label=a[1],a=o;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(o);break}a[2]&&r.ops.pop(),r.trys.pop();continue}o=e.call(t,r)}catch(t){o=[6,t],s=0}finally{i=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,h])}}}function n(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],s=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&s>=t.length&&(t=void 0),{value:t&&t[s++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function r(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var s,a,n=i.call(t),r=[];try{for(;(void 0===e||e-- >0)&&!(s=n.next()).done;)r.push(s.value)}catch(t){a={error:t}}finally{try{s&&!s.done&&(i=n.return)&&i.call(n)}finally{if(a)throw a.error}}return r}function o(t,e,i){if(i||2===arguments.length)for(var s,a=0,n=e.length;a<n;a++)!s&&a in e||(s||(s=Array.prototype.slice.call(e,0,a)),s[a]=e[a]);return t.concat(s||Array.prototype.slice.call(e))}function h(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++){var s=Math.floor(16*Math.random());t[i]=e.slice(s,s+1)}t[14]="4";var a=3&t[19]|8;return t[19]=e.slice(a,a+1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}function c(t,e,i){for(var s=!1,a=i.length,n=0,r=a-1;n<a;r=n++){var o=i[n][0],h=i[n][1],c=i[r][0],l=i[r][1];h>e!=l>e&&t<(c-o)*(e-h)/(l-h)+o&&(s=!s)}return s}function l(t,e){if(void 0===e&&(e=new WeakMap),null===t||"object"!=typeof t)return t;if(e.has(t))return e.get(t);if(t instanceof ImageData){var i=new ImageData(new Uint8ClampedArray(t.data),t.width,t.height);return e.set(t,i),i}if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return new RegExp(t.source,t.flags);if(t instanceof Map){var s=new Map;return e.set(t,s),t.forEach((function(t,i){s.set(l(i,e),l(t,e))})),s}if(t instanceof Set){var a=new Set;return e.set(t,a),t.forEach((function(t){a.add(l(t,e))})),a}if(Array.isArray(t)){var n=[];return e.set(t,n),t.forEach((function(t,i){n[i]=l(t,e)})),n}var r=Object.create(Object.getPrototypeOf(t));return e.set(t,r),Reflect.ownKeys(t).forEach((function(i){var s=t[i];r[i]=l(s,e)})),r}function u(t,e,i){var s,a,r,o;if(t===e)return!0;if(8===t.type&&8===e.type){try{for(var h=n(["uuid","label","maskBase64"]),c=h.next();!c.done;c=h.next()){if(t[g=c.value]!==e[g])return!1}}catch(t){s={error:t}}finally{try{c&&!c.done&&(a=h.return)&&a.call(h)}finally{if(s)throw s.error}}return!0}if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;if(Array.isArray(t)&&Array.isArray(e)){if(t.length!==e.length)return!1;for(var l=0;l<t.length;l++)if(!u(t[l],e[l],i))return!1;return!0}var d=i||Object.keys(t);try{for(var p=n(d),f=p.next();!f.done;f=p.next()){var g;if(!((g=f.value)in t)&&g in e||g in t&&!(g in e)||!u(t[g],e[g]))return!1}}catch(t){r={error:t}}finally{try{f&&!f.done&&(o=p.return)&&o.call(p)}finally{if(r)throw r.error}}return!0}"function"==typeof SuppressedError&&SuppressedError;var d,p=function(t,e){this.tagId="",this.label="",this.labelId="",this.truncated=0,this.coor=[],this.active=!1,this.creating=!1,this.dragging=!1,this.hiddening=!1,this.locking=!1,this.uuid=h(),this.index=e,Object.assign(this,t)},f=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=1,s.iscontour=!1,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){var t=r(this.coor,2),e=r(t[0],2),i=e[0],s=e[1],a=r(t[1],2),n=a[0],o=a[1];return[[i,s],[i+(n-i)/2,s],[n,s],[n,s+(o-s)/2],[n,o],[i+(n-i)/2,o],[i,o],[i,s+(o-s)/2]]},enumerable:!1,configurable:!0}),i}(p),g=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=2,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){return this.coor.length>2?this.coor:[]},enumerable:!1,configurable:!0}),i}(p),v=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=3,s.color="",s.color=e.color||s.color,s}return e(i,t),i}(p),y=function(){function t(){this._eventTree={}}return t.prototype.on=function(t,e){var i=this._eventTree[t];Array.isArray(i)?i.push(e):this._eventTree[t]=[e]},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var s=this._eventTree[t];Array.isArray(s)&&s.forEach((function(t){return t.apply(void 0,o([],r(e),!1))}))},t.prototype.off=function(t,e){var i=this._eventTree[t],s=i.find((function(t){return t===e}));Array.isArray(i)&&s&&i.splice(s,1)},t}(),I=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=4,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){return this.coor.length>1?this.coor:[]},enumerable:!1,configurable:!0}),i}(p),m=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=5,s.radius=0,s.radius=e.radius||s.radius,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){var t=r(this.coor,2),e=t[0],i=t[1];return[[e,i-this.radius],[e+this.radius,i],[e,i+this.radius],[e-this.radius,i]]},enumerable:!1,configurable:!0}),i}(p),S=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=6,s.row=1,s.col=1,s.selected=[],s.row=e.row>0?e.row:s.row,s.col=e.col>0?e.col:s.col,s.selected=Array.isArray(e.selected)?e.selected:[],s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){var t=r(this.coor,2),e=r(t[0],2),i=e[0],s=e[1],a=r(t[1],2),n=a[0],o=a[1];return[[i,s],[i+(n-i)/2,s],[n,s],[n,s+(o-s)/2],[n,o],[i+(n-i)/2,o],[i,o],[i,s+(o-s)/2]]},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"gridRects",{get:function(){for(var t=r(this.coor,2),e=r(t[0],2),i=e[0],s=e[1],a=r(t[1],2),n=a[0],o=a[1],h=this,c=h.row,l=h.col,u=h.strokeStyle,d=h.fillStyle,p=h.active,g=h.creating,v=h.lineWidth,y=(n-i)/this.col,I=(o-s)/this.row,m=[],S=0;S<c;S++)for(var x=0;x<l;x++){var M=[i+x*y,s+S*I],b=new f({coor:[M,[M[0]+y,M[1]+I]],strokeStyle:u,fillStyle:d,active:p,creating:g,lineWidth:v},S*l+x);m.push(b)}return m},enumerable:!1,configurable:!0}),i}(p),x=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=7,s.brushWidth=1,s.iseraser=!1,s.boundingRect=[],s.iseraser=e.iseraser||s.iseraser,s.boundingRect=e.boundingRect||s.boundingRect,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){return this.coor.length>3?this.coor:[]},enumerable:!1,configurable:!0}),i}(p),M=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=8,s.maskType="",s.maskBase64="",s.pixels=[],s.canvasData=null,s.height=0,s.weight=0,s.maskToPolygon=!1,s.magicPoints=[],s.maskType=e.maskType||"",s.maskBase64=e.maskBase64||"",s.pixels=e.pixels||[],s.canvasData=e.canvasData||null,s.height=e.height||0,s.weight=e.weight||0,s.maskToPolygon=e.maskToPolygon||!1,s.magicPoints=e.magicPoints||[],s}return e(i,t),i}(p),b=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=9,s.boundingRect=[],s.boundingRect=e.boundingRect||s.boundingRect,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){return this.coor.length>3?this.coor:[]},enumerable:!1,configurable:!0}),i}(p),E="2.25.0";!function(t){t[t.None=0]="None",t[t.Rect=1]="Rect",t[t.Polygon=2]="Polygon",t[t.Dot=3]="Dot",t[t.Line=4]="Line",t[t.Circle=5]="Circle",t[t.Grid=6]="Grid",t[t.Brush=7]="Brush",t[t.Mask=8]="Mask",t[t.Pencil=9]="Pencil"}(d||(d={}));var H=function(t){function p(e,i){var s=t.call(this)||this;s.version=E,s.lock=!1,s.readonly=!1,s.MIN_WIDTH=10,s.MIN_HEIGHT=10,s.MIN_RADIUS=5,s.MIN_POINTNUM=3,s.MIN_LENGTH=140,s.strokeStyle="#000",s.fillStyle="rgba(0, 0, 255, 0.1)",s.lineWidth=2,s.activeStrokeStyle="#000",s.activeFillStyle="#000",s.ctrlStrokeStyle="#000",s.ctrlFillStyle="#fff",s.ctrlRadius=3,s.hideLabel=!1,s.labelFillStyle="rgba(255, 255, 255, 0.5)",s.labelFontFamily="sans-serif",s.labelFontSize=18,s.textFillStyle="#FFFFFF",s.labelMaxLen=10,s.WIDTH=0,s.HEIGHT=0,s.imagesrc="",s.imagealpha=1,s.olddataset=[],s.dataset=[],s.MAX_LENGTH=10,s.doneList=[],s.undoList=[],s.hideList=[],s.remmberOrigin=[0,0],s.createType=d.None,s.ctrlIndex=-1,s.clickIndex=-1,s.image=new Image,s.IMAGE_WIDTH=0,s.IMAGE_ORIGIN_HEIGHT=0,s.IMAGE_HEIGHT=0,s.originX=0,s.originY=0,s.scaleStep=0,s.textscaleStep=0,s.scrollZoom=!0,s.dblTouch=300,s.dblTouchStore=0,s.alpha=!0,s.focusMode=!1,s.scaleTouchStore=0,s.isTouch2=!1,s.isMobile=navigator.userAgent.includes("Mobile"),s.labelUp=!1,s.isCtrlKey=!1,s.ctrlCode="ControlLeft",s.gridMenuEnable=!0,s.gridSelectedFillStyle="rgba(255, 255, 0, 0.8)",s.ispainting=!1,s.brushlineWidth=1,s.brushstrokeStyle="rgba(255, 0, 0, 0.8)",s.pencillineWidth=.5,s.pencilstrokeStyle="rgba(255, 0, 0, 0.8)",s.mask_alpha=96,s.densityFactor=1,s.activeCanvasData=null,s.activePolygon="",s.isEraser=!1,s.isErasing=!1,s.eraserPoints=[],s.eraserSize=8,s.random_color=[{r:255,g:0,b:0},{r:0,g:255,b:0},{r:0,b:255,g:0}],s.isMagicToolActive=!1,s.magicPoints=[],s.maxLinePointCount=2,s.getImagedataFromImageClass=function(t,e){var i=document.createElement("canvas"),a=i.getContext("2d",{willReadFrequently:!0});if(!i||!a)return console.error("Canvas or context is not initialized"),null;i.width=s.WIDTH,i.height=s.HEIGHT;var n=document.createElement("canvas"),r=n.getContext("2d",{willReadFrequently:!0});if(!r)return console.error("Temporary canvas context is not initialized"),null;n.width=s.WIDTH,n.height=s.HEIGHT,r.drawImage(t,0,0);var o=null==r?void 0:r.getImageData(0,0,n.width,n.height),h=null==o?void 0:o.data;if(!h)return console.error("Failed to retrieve pixel data"),null;var c=a.getImageData(0,0,s.WIDTH,s.HEIGHT),l=c.data;if("everything"===e){for(var u=0;u<h.length;u+=4)if(h[u]>0){var d=h[u]%s.random_color.length;l[u]=s.random_color[d].r,l[u+1]=s.random_color[d].g,l[u+2]=s.random_color[d].b,l[u+3]=s.mask_alpha}a.putImageData(c,0,0)}else if("rect"===e);else{if("magic"!==e)return console.error("Unknown mask type"),null;var p=[];for(u=0;u<h.length;u+=4)255==h[u]&&255==h[u+1]&&255==h[u+2]&&p.push(u)}var f=document.createElement("canvas"),g=f.getContext("2d",{willReadFrequently:!0});return g?(f.width=s.IMAGE_WIDTH,f.height=s.IMAGE_HEIGHT,g.drawImage(t,0,0,s.IMAGE_WIDTH,s.IMAGE_HEIGHT),g.getImageData(0,0,s.IMAGE_WIDTH,s.IMAGE_HEIGHT).data):(console.error("Scaled canvas context is not initialized"),null)},s.drawPromptPointOnClick=function(t,e){var i=t.coor[0]*s.scale,a=t.coor[1]*s.scale,n=t.color,r=e.getContext("2d",{willReadFrequently:!0});r&&(r.beginPath(),r.arc(i,a,3,0,2*Math.PI),r.fillStyle="rgba(255, 255, 255, 0.75)",r.fill(),r.strokeStyle=n,r.stroke())},s.handleLoad=s.handleLoad.bind(s),s.handleContextmenu=s.handleContextmenu.bind(s),s.handleMousewheel=s.handleMousewheel.bind(s),s.handleMouseDown=s.handleMouseDown.bind(s),s.handleMouseMove=s.handleMouseMove.bind(s),s.handleMouseUp=s.handleMouseUp.bind(s),s.handleDblclick=s.handleDblclick.bind(s),s.handleKeyup=s.handleKeyup.bind(s),s.handleKeydown=s.handleKeydown.bind(s);var a="string"==typeof e?document.querySelector(e):e;if(a instanceof HTMLCanvasElement){s.canvas=a,s.offScreen=document.createElement("canvas"),s.imagesrc=i,s.initSetting(),s.initEvents(),i&&s.setImage(i);for(var n=1;n<=255;n++){var r=Math.floor(256*Math.random()),o=Math.floor(256*Math.random()),h=Math.floor(256*Math.random());s.random_color[n]={r:r,g:o,b:h}}}else console.warn("HTMLCanvasElement is required!");return s}return e(p,t),Object.defineProperty(p.prototype,"activeShape",{get:function(){return this.dataset.find((function(t){return t.active}))||{}},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"scale",{get:function(){return this.IMAGE_ORIGIN_WIDTH&&this.IMAGE_WIDTH?this.IMAGE_WIDTH/this.IMAGE_ORIGIN_WIDTH:1},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"imageMin",{get:function(){return Math.min(this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"imageOriginMax",{get:function(){return Math.max(this.IMAGE_ORIGIN_WIDTH,this.IMAGE_ORIGIN_HEIGHT)},enumerable:!1,configurable:!0}),p.prototype.mergeEvent=function(t){var e=0,s=0,a=0,n=0;if(this.isMobile){var r=t.touches[0],o=r.clientX,h=r.clientY,c=t.target.getBoundingClientRect(),l=c.left,u=c.top;if(e=Math.round(o-l),s=Math.round(h-u),2===t.touches.length){var d=t.touches[1]||{},p=d.clientX,f=void 0===p?0:p,g=d.clientY,v=void 0===g?0:g;a=Math.round(Math.abs((f-o)/2+o)-l),n=Math.round(Math.abs((v-h)/2+h)-u)}}else e=t.offsetX,s=t.offsetY;return i(i({},t),{mouseX:e,mouseY:s,mouseCX:a,mouseCY:n})},p.prototype.handleLoad=function(){this.emit("load",this.image.src),this.IMAGE_ORIGIN_WIDTH=this.IMAGE_WIDTH=this.image.width,this.IMAGE_ORIGIN_HEIGHT=this.IMAGE_HEIGHT=this.image.height,this.fitZoom()},p.prototype.handleContextmenu=function(t){t.preventDefault(),this.evt=t,this.lock},p.prototype.handleMousewheel=function(t){if(t.stopPropagation(),this.evt=t,!this.lock&&this.scrollZoom){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY;this.mouse=[i,s],t.deltaY>0&&this.imageMin<this.MIN_LENGTH||t.deltaY<0&&this.IMAGE_WIDTH>10*this.imageOriginMax||(t.deltaY<0?this.textscaleStep++:this.textscaleStep--,this.setScale(t.deltaY<0,!0))}},p.prototype.handleMouseDown=function(t){var e=this;if(t.stopPropagation(),this.evt=t,!this.lock){var i=this.mergeEvent(t),s=i.mouseX,a=i.mouseY,n=i.mouseCX,o=i.mouseCY,h=Math.round(s/this.scale),c=Math.round(a/this.scale);if(this.mouse=this.isMobile&&2===t.touches.length?[n,o]:[s,a],this.remmberOrigin=[s-this.originX,a-this.originY],this.olddataset=l(this.dataset),!this.isMobile&&1===t.buttons||this.isMobile&&1===t.touches.length){var u=this.activeShape.ctrlsData||[];if(this.ctrlIndex=u.findIndex((function(t){return e.isPointInCircle(e.mouse,t,e.ctrlRadius)})),this.clickIndex=this.ctrlIndex,this.ctrlIndex>-1&&!this.readonly){console.log("this.ctrlIndex",this.ctrlIndex);var p=r(u[this.ctrlIndex],2),y=p[0],M=p[1];this.activeShape.type===d.Polygon&&this.activeShape.coor.length>2&&0===this.ctrlIndex?this.handleDblclick(t):this.update(),this.remmber=[[h-y,c-M]]}else if(this.isInBackground(t)){if(this.activeShape.creating&&!this.readonly){if([d.Polygon,d.Line].includes(this.activeShape.type)){var E=r(this.activeShape.coor[this.activeShape.coor.length-1],2),H=E[0],T=E[1];if(H!==h&&T!==c){var k=Math.round(h-this.originX/this.scale),G=Math.round(c-this.originY/this.scale);this.activeShape.coor.push([k,G])}}}else if(this.createType===d.None||this.readonly||this.isCtrlKey){var w=r(this.hitOnShape(this.mouse),2),D=w[0],P=w[1];if(D>-1&&!P.locking&&!this.readonly){if(P.type===d.Dot&&"color"in P&&""!==P.color)return;if(P.type===d.Brush)return void("iseraser"in P&&!P.iseraser&&(this.dataset.forEach((function(t,e){return t.active=e===D})),this.emit("select",P)));if(P.type===d.Pencil)return this.dataset.forEach((function(t,e){return t.active=e===D})),this.emit("select",P),void this.update();if(P.dragging=!0,this.dataset.forEach((function(t,e){return t.active=e===D})),this.dataset.splice(D,1,P),!this.readonly)if(this.remmber=[],[d.Dot,d.Circle].includes(P.type)){var _=r(P.coor,2);H=_[0],T=_[1];this.remmber=[[h-H,c-T]]}else P.coor.forEach((function(t){e.remmber.push([h-t[0],c-t[1]])}));this.emit("select",P)}else this.activeShape.active=!1,this.dataset.sort((function(t,e){return t.index-e.index})),this.emit("select",null)}else{var W=void 0,A=[k=Math.round(h-this.originX/this.scale),G=Math.round(c-this.originY/this.scale)];switch(this.createType){case d.Rect:(W=new f({coor:[A,A]},this.dataset.length)).creating=!0;break;case d.Polygon:(W=new g({coor:[A]},this.dataset.length)).creating=!0;break;case d.Dot:W=new v({coor:A},this.dataset.length),this.emit("add",W);break;case d.Line:(W=new I({coor:[A]},this.dataset.length)).creating=!0;break;case d.Circle:(W=new m({coor:A},this.dataset.length)).creating=!0;break;case d.Grid:(W=new S({coor:[A,A]},this.dataset.length)).creating=!0;break;case d.Brush:(W=new x({coor:[A]},this.dataset.length)).creating=!0,W.lineWidth=this.brushlineWidth,W.strokeStyle=this.brushstrokeStyle,this.ispainting=!0,this.isEraser&&(W.iseraser=!0);break;case d.Pencil:(W=new b({coor:[A]},this.dataset.length)).creating=!0,W.lineWidth=this.pencillineWidth,W.strokeStyle=this.pencilstrokeStyle,this.ispainting=!0}this.dataset.forEach((function(t){t.active=!1})),W.active=!0,this.dataset.push(W)}this.update()}else this.activeShape.active=!1,this.dataset.sort((function(t,e){return t.index-e.index})),this.emit("select",null),this.update()}else if(!this.isMobile&&2===t.buttons||this.isMobile&&3===t.touches.length&&!this.readonly){if([d.Grid].includes(this.activeShape.type)&&this.gridMenuEnable){var C=prompt("x 行 y 列 x,y",[this.activeShape.row,this.activeShape.col].join(","));if("string"==typeof C){var L=r(C.split(","),2),R=L[0],O=L[1];/^[1-9]\d*$/.test(R)&&/^[1-9]\d*$/.test(O)&&(this.activeShape.row=Number(R),this.activeShape.col=Number(O),this.update())}}this.emit("contextmenu",t)}}},p.prototype.handleMouseMove=function(t){if(t.stopPropagation(),this.evt=t,!this.lock){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY,a=e.mouseCX,n=e.mouseCY,o=Math.round(i/this.scale),h=Math.round(s/this.scale);if(this.mouse=this.isMobile&&2===t.touches.length?[a,n]:[i,s],(!this.isMobile&&1===t.buttons||this.isMobile&&1===t.touches.length)&&this.activeShape.type){if(this.ctrlIndex>-1&&this.remmber.length&&(this.isInBackground(t)||this.activeShape.type===d.Circle)){var c=r(this.remmber,1),l=r(c[0],2),u=l[0],p=l[1];if([d.Rect,d.Grid].includes(this.activeShape.type)){var f=r(this.activeShape.coor,2),g=r(f[0],2),v=g[0],y=g[1],I=r(f[1],2),m=I[0],S=I[1],x=[];switch(this.ctrlIndex){case 0:x=[[o-u,h-p],[m,S]];break;case 1:x=[[v,h-p],[m,S]];break;case 2:x=[[v,h-p],[o-u,S]];break;case 3:x=[[v,y],[o-u,S]];break;case 4:x=[[v,y],[o-u,h-p]];break;case 5:x=[[v,y],[m,h-p]];break;case 6:x=[[o-u,y],[m,h-p]];break;case 7:x=[[o-u,y],[m,S]]}var M=r(x,2),b=r(M[0],2),E=b[0],H=b[1],T=r(M[1],2),k=T[0],G=T[1];(E<0||k<0||H<0||G<0||k>this.IMAGE_ORIGIN_WIDTH||G>this.IMAGE_ORIGIN_HEIGHT)&&(E<0&&(E=0),k<0&&(k=0),H<0&&(H=0),G<0&&(G=0),k>this.IMAGE_ORIGIN_WIDTH&&(k=this.IMAGE_ORIGIN_WIDTH),G>this.IMAGE_ORIGIN_HEIGHT&&(G=this.IMAGE_ORIGIN_HEIGHT)),k-E>=this.MIN_WIDTH&&G-H>=this.MIN_HEIGHT?this.activeShape.coor=[[E,H],[k,G]]:this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than").concat(this.MIN_HEIGHT,"。"))}else if([d.Polygon,d.Line].includes(this.activeShape.type)){var w=[Math.round(o-this.originX/this.scale),Math.round(h-this.originY/this.scale)];this.activeShape.coor.splice(this.ctrlIndex,1,w)}else if(this.activeShape.type===d.Circle){var D=Math.round(o-this.originX/this.scale)-this.activeShape.coor[0];D>=this.MIN_RADIUS&&(this.activeShape.radius=D)}}else if(this.activeShape.dragging&&!this.readonly){x=[];var P=!0,_=this.IMAGE_ORIGIN_WIDTH||this.WIDTH,W=this.IMAGE_ORIGIN_HEIGHT||this.HEIGHT;if([d.Dot,d.Circle].includes(this.activeShape.type)){var A=r(this.remmber[0],2),C=A[0];p=h-A[1];((u=o-C)<0||u>_||p<0||p>W)&&(P=!1),x=[u,p]}else for(var L=0;L<this.activeShape.coor.length;L++){var R=this.remmber[L];u=o-R[0],p=h-R[1];(u<0||u>_||p<0||p>W)&&(P=!1),x.push([u,p])}P&&(this.activeShape.coor=x)}else if(this.activeShape.creating&&this.isInBackground(t)){u=Math.round(o-this.originX/this.scale),p=Math.round(h-this.originY/this.scale);if([d.Rect,d.Grid].includes(this.activeShape.type))this.activeShape.coor.splice(1,1,[u,p]);else if(this.activeShape.type===d.Circle){var O=r(this.activeShape.coor,2),Y=(v=O[0],y=O[1],Math.sqrt(Math.pow(v-u,2)+Math.pow(y-p,2)));this.activeShape.radius=Y}else if(this.ispainting&&this.createType===d.Brush){w=[Math.round(o-this.originX/this.scale),Math.round(h-this.originY/this.scale)];this.activeShape.coor.push(w)}else if(this.ispainting&&this.createType===d.Pencil){w=[Math.round(o-this.originX/this.scale),Math.round(h-this.originY/this.scale)];this.activeShape.coor.push(w)}}this.update()}else if([d.Polygon,d.Line,d.Brush,d.Pencil].includes(this.activeShape.type)&&this.activeShape.creating)this.update();else if(!this.isMobile&&2===t.buttons&&3===t.which||this.isMobile&&1===t.touches.length&&!this.isTouch2)this.originX=Math.round(i-this.remmberOrigin[0]),this.originY=Math.round(s-this.remmberOrigin[1]),this.emit("dragimg"),this.update();else if(this.isMobile&&2===t.touches.length){this.isTouch2=!0;var X=t.touches[0],N=t.touches[1],B=this.scaleTouchStore;this.scaleTouchStore=Math.abs((N.clientX-X.clientX)*(N.clientY-X.clientY)),this.setScale(this.scaleTouchStore>B,!0)}}},p.prototype.handleMouseUp=function(t){if(console.log("handleMouseUp"),t.stopPropagation(),this.evt=t,!this.lock){if(this.isMobile){if(0===t.touches.length&&(this.isTouch2=!1),Date.now()-this.dblTouchStore<this.dblTouch)return void this.handleDblclick(t);this.dblTouchStore=Date.now()}if(this.remmber=[],this.activeShape.type!==d.None&&!this.isCtrlKey){if(this.activeShape.dragging=!1,this.activeShape.creating){if([d.Rect,d.Grid].includes(this.activeShape.type)){var e=r(this.activeShape.coor,2),i=r(e[0],2),s=i[0],a=i[1],n=r(e[1],2),o=n[0],h=n[1];if(Math.abs(s-o)<this.MIN_WIDTH||Math.abs(a-h)<this.MIN_HEIGHT)this.dataset.pop(),this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than ").concat(this.MIN_HEIGHT));else{this.activeShape.coor=[[Math.min(s,o),Math.min(a,h)],[Math.max(s,o),Math.max(a,h)]],this.activeShape.creating=!1,this.activeShape.truncated=0;for(var c=0;c<this.dataset.length;c++)this.dataset[c].type===d.Rect&&this.dataset[c].index!==this.activeShape.index&&this.dataset[c].coor[1][0]>this.activeShape.coor[0][0]&&this.dataset[c].coor[0][0]<this.activeShape.coor[1][0]&&this.dataset[c].coor[1][1]>this.activeShape.coor[0][1]&&this.dataset[c].coor[0][1]<this.activeShape.coor[1][1]&&(this.activeShape.truncated=1);this.emit("add",this.activeShape)}}else if(this.activeShape.type===d.Circle)this.activeShape.radius<this.MIN_RADIUS?(this.dataset.pop(),this.emit("warn","Radius cannot be less than ".concat(this.MIN_WIDTH))):(this.activeShape.creating=!1,this.emit("add",this.activeShape));else if(this.createType===d.Brush)if(this.activeShape.coor.length<this.MIN_POINTNUM)this.dataset.pop(),this.emit("warn","Path points cannot be less than ".concat(this.MIN_POINTNUM));else{this.ispainting=!1,this.activeShape.creating=!1;var p=this.removeDuplicatePoints(this.activeShape.coor,!0),f=p.resultCoor,g=p.resultRect;this.activeShape.coor=f,this.activeShape.boundingRect=g,this.emit("add",this.activeShape)}else if(this.createType===d.Pencil)if(this.activeShape.coor.length<this.MIN_POINTNUM)this.dataset.pop(),this.emit("warn","Path points cannot be less than ".concat(this.MIN_POINTNUM));else{this.activeShape.coor.push([-1,-1]),this.ispainting=!1,this.activeShape.creating=!1;var v=this.removeDuplicatePoints(this.activeShape.coor,!0);f=v.resultCoor,g=v.resultRect;this.activeShape.coor=f,this.activeShape.boundingRect=g,this.emit("add",this.activeShape)}else if(this.createType===d.Line){if(this.activeShape.coor.length===this.maxLinePointCount)this.activeShape.type===d.Line&&this.activeShape.coor.length>1&&(this.emit("add",this.activeShape),this.activeShape.creating=!1)}this.update()}u(this.olddataset,this.dataset,["coor","label","labelUp","lineWidth","strokeStyle","textFillStyle","uuid","remark","length"])||(this.manageDoneList(l(this.dataset)),console.log("this.doneList",this.doneList))}}},p.prototype.handleDblclick=function(t){var e=this;if(t.stopPropagation(),this.evt=t,!this.lock)if([d.Polygon,d.Line].includes(this.activeShape.type)){var i=this.activeShape.type===d.Polygon&&this.activeShape.coor.length>2,s=this.activeShape.type===d.Line&&this.activeShape.coor.length>1;(i||s)&&(this.emit("add",this.activeShape),this.activeShape.creating=!1,this.update())}else[d.Grid].includes(this.activeShape.type)&&this.activeShape.active&&(this.activeShape.gridRects.forEach((function(t){if(e.isPointInRect(e.mouse,t.coor)){var i=e.activeShape.selected.findIndex((function(e){return t.index===e}));i>-1?e.activeShape.selected.splice(i,1):e.activeShape.selected.push(t.index)}})),this.update())},p.prototype.handleKeydown=function(t){t.code===this.ctrlCode&&(this.isCtrlKey=!0)},p.prototype.handleKeyup=function(t){t.code===this.ctrlCode&&(this.isCtrlKey=!1),this.evt=t,!this.isCtrlKey||"v"!==t.key||this.readonly?this.lock||document.activeElement!==document.body||this.readonly||this.activeShape.type&&([d.Polygon,d.Line].includes(this.activeShape.type)&&"Escape"===t.key?(this.activeShape.coor.length>1&&this.activeShape.creating?this.activeShape.coor.pop():this.deleteByIndex(this.activeShape.index),this.update()):"Backspace"!==t.key&&"Delete"!==t.key||this.deleteByIndex(this.activeShape.index)):this.copyByIndex(this.activeShape.index)},p.prototype.initSetting=function(){var t=window.devicePixelRatio||1;this.canvas.style.userSelect="none",this.ctx=this.ctx||this.canvas.getContext("2d",{alpha:this.alpha,willReadFrequently:!0}),this.WIDTH=Math.round(this.canvas.clientWidth),this.HEIGHT=Math.round(this.canvas.clientHeight),this.canvas.width=this.WIDTH*t,this.canvas.height=this.HEIGHT*t,this.canvas.style.width=this.WIDTH+"px",this.canvas.style.height=this.HEIGHT+"px",this.offScreen.width=this.WIDTH,this.offScreen.height=this.HEIGHT,this.offScreenCtx=this.offScreenCtx||this.offScreen.getContext("2d",{willReadFrequently:!0}),this.ctx.scale(t,t)},p.prototype.initEvents=function(){this.canvas&&(this.image.addEventListener("load",this.handleLoad),this.canvas.addEventListener("touchstart",this.handleMouseDown),this.canvas.addEventListener("touchmove",this.handleMouseMove),this.canvas.addEventListener("touchend",this.handleMouseUp),this.canvas.addEventListener("contextmenu",this.handleContextmenu),this.canvas.addEventListener("mousewheel",this.handleMousewheel),this.canvas.removeEventListener("wheel",this.handleMousewheel),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("dblclick",this.handleDblclick),document.body.addEventListener("keydown",this.handleKeydown,!0),document.body.addEventListener("keyup",this.handleKeyup,!0))},p.prototype.getscaledPoint=function(t){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY,a=Math.round(i/this.scale),n=Math.round(s/this.scale);return[Math.round(a-this.originX/this.scale),Math.round(n-this.originY/this.scale)]},p.prototype.setImage=function(t,e){void 0===e&&(e=1),this.image.crossOrigin="Anonymous",this.image.src=t,this.imagealpha=e,this.scaleStep=0,this.textscaleStep=0},p.prototype.handleMaskShape=function(t,e){return s(this,void 0,void 0,(function(){var i,s,n,r=this;return a(this,(function(a){return i=new M(t,e),s=i.maskBase64,(n=new Image).crossOrigin="Anonymous",n.src="data:image/png;base64,".concat(s),[2,new Promise((function(s,a){n.onload=function(){var o=[],h=r.getImagedataFromImageClass(n,"magic");if(h){for(var c=0;c<h.length;c+=4)255===h[c]&&255===h[c+1]&&255===h[c+2]&&o.push(c);if(i.pixels=o,i.height=r.IMAGE_HEIGHT,i.weight=r.IMAGE_WIDTH,i.fillStyle=t.fillStyle,i.strokeStyle=t.strokeStyle,"maskToPolygon"in t&&t.maskToPolygon&&"click"===i.maskType){r.activeCanvasData=r.putDataOnCanvas(r.canvas,o,i.fillStyle,!1);var l=new g({coor:r.getContourPointsOfColoredRegion(r.activeCanvasData,.5)},e);l.tagId=t.tagId,l.label=t.label,l.strokeStyle=t.strokeStyle,r.activePolygon=l.uuid,s(l)}else i.canvasData=r.putDataOnCanvas(r.canvas,o,i.fillStyle,!0),i.tagId=t.tagId,i.label=t.label,s(i);r.magicPoints=i.magicPoints}else console.error("Failed to get pixel data from mask image"),a(null)},n.onerror=function(t){console.error("Error loading mask image",t),a(null)}}))]}))}))},p.prototype.setData=function(t,e,i,r){var o=this;return void 0===e&&(e=!0),void 0===i&&(i=!1),void 0===r&&(r=!1),new Promise((function(h){setTimeout((function(){return s(o,void 0,void 0,(function(){var s,o,c,u,p,y,M,E,H,T;return a(this,(function(a){switch(a.label){case 0:if(!e)return[3,21];s=[],o=new Map,t.forEach((function(t,e){o.set(t,e)})),a.label=1;case 1:a.trys.push([1,18,19,20]),c=n(t),u=c.next(),a.label=2;case 2:if(u.done)return[3,17];if(p=u.value,!Object.prototype.toString.call(p).includes("Object"))return[3,15];switch(y=void 0,M=o.get(p),p.type){case d.Rect:return[3,3];case d.Polygon:return[3,4];case d.Dot:return[3,5];case d.Line:return[3,6];case d.Circle:return[3,7];case d.Grid:return[3,8];case d.Brush:return[3,9];case d.Mask:return[3,10];case d.Pencil:return[3,12]}return[3,13];case 3:return y=new f(p,M),[3,14];case 4:return y=new g(p,M),[3,14];case 5:return y=new v(p,M),[3,14];case 6:return y=new I(p,M),[3,14];case 7:return y=new m(p,M),[3,14];case 8:return y=new S(p,M),[3,14];case 9:return y=new x(p,M),[3,14];case 10:return[4,this.handleMaskShape(p,M)];case 11:return y=a.sent(),[3,14];case 12:return y=new b(p,M),[3,14];case 13:return console.warn("Invalid shape",p),[3,14];case 14:return[d.Rect,d.Polygon,d.Dot,d.Line,d.Circle,d.Grid,d.Brush,d.Mask,d.Pencil].includes(p.type)&&s.push(y),[3,16];case 15:console.warn("Shape must be an enumerable Object.",p),a.label=16;case 16:return u=c.next(),[3,2];case 17:return[3,20];case 18:return E=a.sent(),H={error:E},[3,20];case 19:try{u&&!u.done&&(T=c.return)&&T.call(c)}finally{if(H)throw H.error}return[7];case 20:return this.dataset=s,[3,22];case 21:this.dataset=t,a.label=22;case 22:return this.update(i,r),0===this.doneList.length&&void 0!==this.dataset&&this.manageDoneList(l(this.dataset)),h(),[2]}}))}))}),0)}))},p.prototype.hitOnShape=function(t){for(var e,i=-1,s=this.dataset.length-1;s>-1;s--){var a=this.dataset[s];if(this.isPointInBackground(t)&&(a.type===d.Dot&&this.isPointInCircle(t,a.coor,this.ctrlRadius)||a.type===d.Circle&&this.isPointInCircle(t,a.coor,a.radius*this.scale)||a.type===d.Rect&&this.isPointInRect(t,a.coor)||a.type===d.Polygon&&this.isPointInPolygon(t,a.coor)||a.type===d.Line&&this.isPointInLine(t,a.coor)||a.type===d.Grid&&this.isPointInRect(t,a.coor)||a.type===d.Brush&&this.isPointInLine(t,a.coor)||a.type===d.Pencil&&this.isPointInPolygon(t,a.coor)||a.type===d.Mask&&this.isMouseInPixelsRegion(t,a.canvasData))){if(this.focusMode&&!a.active||a.hiddening)continue;i=s,e=a;break}}return[i,e]},p.prototype.hitOnShapeVertex=function(){var t=this,e=this.activeShape,i=this.activeShape.ctrlsData||[];return this.ctrlIndex=i.findIndex((function(e){return t.isPointInCircle(t.mouse,e,t.ctrlRadius)})),this.ctrlIndex>-1&&!this.readonly&&!e.hiddening?e.type===d.Rect?0===this.ctrlIndex?"nw-resize":1===this.ctrlIndex?"ns-resize":2===this.ctrlIndex?"ne-resize":3===this.ctrlIndex?"ew-resize":4===this.ctrlIndex?"se-resize":5===this.ctrlIndex?"ns-resize":6===this.ctrlIndex?"sw-resize":"ew-resize":e.type===d.Brush||e.type===d.Pencil||e.type===d.Polygon||e.type===d.Line||e.type===d.Circle?"pointer":"move":""},p.prototype.isInBackground=function(t){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY;return i>=this.originX&&s>=this.originY&&i<=this.originX+this.IMAGE_ORIGIN_WIDTH*this.scale&&s<=this.originY+this.IMAGE_ORIGIN_HEIGHT*this.scale},p.prototype.isPointInBackground=function(t){var e=t[0],i=t[1];return e>=this.originX&&i>=this.originY&&e<=this.originX+this.IMAGE_ORIGIN_WIDTH*this.scale&&i<=this.originY+this.IMAGE_ORIGIN_HEIGHT*this.scale},p.prototype.isPointInRect=function(t,e){var i=this,s=r(t,2),a=s[0],n=s[1],o=r(e.map((function(t){return t.map((function(t){return t*i.scale}))})),2),h=r(o[0],2),c=h[0],l=h[1],u=r(o[1],2),d=u[0],p=u[1];return c+this.originX<a&&a<d+this.originX&&l+this.originY<n&&n<p+this.originY},p.prototype.isPointOnRectEdge=function(t,e){var i=this,s=r(t,2),a=s[0],n=s[1],o=r(e.map((function(t){return t.map((function(t){return t*i.scale}))})),2),h=r(o[0],2),c=h[0],l=h[1],u=r(o[1],2),d=u[0],p=u[1],f=a===c+this.originX&&n>=l+this.originY&&n<=p+this.originY,g=a===d+this.originX&&n>=l+this.originY&&n<=p+this.originY,v=n===l+this.originY&&a>=c+this.originX&&a<=d+this.originX,y=n===p+this.originY&&a>=c+this.originX&&a<=d+this.originX;return f||g?"ew-resize":v||y?"ns-resize":"none"},p.prototype.isPointOnRectVertex=function(t,e){var i=this,s=r(t,2),a=s[0],n=s[1],o=r(e.map((function(t){return t.map((function(t){return t*i.scale}))})),2),h=r(o[0],2),c=h[0],l=h[1],u=r(o[1],2),d=u[0],p=u[1],f=a===c+this.originX&&n===l+this.originY,g=a===d+this.originX&&n===p+this.originY,v=a===d+this.originX&&n===l+this.originY,y=a===c+this.originX&&n===p+this.originY;return f?"nw-resize":g?"se-resize":v?"ne-resize":y?"sw-resize":"none"},p.prototype.isPointInPolygon=function(t,e){var i=this;this.offScreenCtx.save(),this.offScreenCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offScreenCtx.translate(this.originX,this.originY),this.offScreenCtx.beginPath(),e.forEach((function(t,e){var s=r(t.map((function(t){return Math.round(t*i.scale)})),2),a=s[0],n=s[1];0===e?i.offScreenCtx.moveTo(a,n):i.offScreenCtx.lineTo(a,n)})),this.offScreenCtx.closePath(),this.offScreenCtx.fill();var s=this.offScreenCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),a=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offScreenCtx.restore(),0!==s.data[a+3]},p.prototype.isPointOnPolygonVertex=function(t,e){var i=this;return e.some((function(e){var s=r(e.map((function(t){return Math.round(t*i.scale)})),2),a=s[0],n=s[1];return a===t[0]+i.originX&&n===t[1]+i.originY}))},p.prototype.isPointInCircle=function(t,e,i){var s=this,a=r(t,2),n=a[0],o=a[1],h=r(e.map((function(t){return t*s.scale})),2),c=h[0],l=h[1];return Math.sqrt(Math.pow(c+this.originX-n,2)+Math.pow(l+this.originY-o,2))<=i},p.prototype.isPointOnCircleVertex=function(t,e,i){var s=this,a=r(t,2),n=a[0],o=a[1],h=r(e.map((function(t){return t*s.scale})),2),c=h[0],l=h[1];return n===c+this.originX+i&&o===l+this.originY},p.prototype.isPointInLine=function(t,e){var i=this;this.offScreenCtx.save(),this.offScreenCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offScreenCtx.translate(this.originX,this.originY),this.offScreenCtx.lineWidth=this.lineWidth>5?this.lineWidth:5,this.offScreenCtx.beginPath(),e.forEach((function(t,e){var s=r(t.map((function(t){return Math.round(t*i.scale)})),2),a=s[0],n=s[1];0===e?i.offScreenCtx.moveTo(a,n):i.offScreenCtx.lineTo(a,n)})),this.offScreenCtx.stroke();var s=this.offScreenCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),a=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offScreenCtx.restore(),0!==s.data[a+3]},p.prototype.isMouseInPixelsRegion=function(t,e){var i=Math.floor(t[0]-this.originX),s=4*(Math.floor(t[1]-this.originY)*Math.floor(this.IMAGE_WIDTH)+i);return 0!==e.data[s+3]},p.prototype.getBoundingBoxOfColoredRegion=function(t){for(var e=t.data,i=t.width,s=t.height,a=i,n=0,r=s,o=0,h=0;h<s;h++)for(var c=0;c<i;c++){var l=4*(h*i+c),u=e[l],d=e[l+1],p=e[l+2];0===e[l+3]||255===u&&255===d&&255===p||(a=Math.min(a,c),n=Math.max(n,c),r=Math.min(r,h),o=Math.max(o,h))}return a>n||r>o?[]:[[Math.round(a/this.scale),Math.round(r/this.scale)],[Math.round(n/this.scale),Math.round(o/this.scale)]]},p.prototype.getContourPointsOfColoredRegion=function(t,e){void 0===e&&(e=1);for(var i=t.data,s=t.width,a=t.height,n=[],r=0;r<a;r++)for(var o=0;o<s;o++){var h=4*(r*s+o),c=i[h],l=i[h+1],u=i[h+2];if(0!==i[h+3]&&(255!==c||255!==l||255!==u))this.isBorderPoint(o,r,s,a,i)&&n.push([Math.round(o/this.scale),Math.round(r/this.scale)])}var d=this.removeDuplicatePoints(n,!1).resultCoor,p=this.samplePointsByDensity(d,e);return this.sortByPolarAngle(p)},p.prototype.isBorderPoint=function(t,e,i,s,a){var o,h;try{for(var c=n([[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]]),l=c.next();!l.done;l=c.next()){var u=r(l.value,2),d=u[0],p=u[1],f=t+d,g=e+p;if(f>=0&&f<i&&g>=0&&g<s)if(0===a[4*(g*i+f)+3])return!0}}catch(t){o={error:t}}finally{try{l&&!l.done&&(h=c.return)&&h.call(c)}finally{if(o)throw o.error}}return!1},p.prototype.samplePointsByDensity=function(t,e){for(var i=[],s=Math.max(1,Math.floor(1/e)),a=0;a<t.length;a+=s)i.push(t[a]);return i},p.prototype.calculateCentroid=function(t){var e,i,s=0,a=0;try{for(var r=n(t),o=r.next();!o.done;o=r.next()){var h=o.value;s+=h[0],a+=h[1]}}catch(t){e={error:t}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}var c=t.length;return[s/c,a/c]},p.prototype.calculatePolarAngle=function(t,e){var i=e[0]-t[0],s=e[1]-t[1];return Math.atan2(s,i)},p.prototype.sortByPolarAngle=function(t){var e=this,i=this.calculateCentroid(t);return t.sort((function(t,s){return e.calculatePolarAngle(i,t)-e.calculatePolarAngle(i,s)}))},p.prototype.isNested=function(t,e){return function(t,e){if(1===t.type&&1===e.type){var i=r(t.coor,2),s=r(i[0],2),a=s[0],n=s[1],o=r(i[1],2),h=o[0],l=o[1],u=r(e.coor,2),d=r(u[0],2),p=d[0],f=d[1],g=r(u[1],2),v=g[0],y=g[1];return a<=p&&n<=f&&h>=v&&l>=y}if(1===t.type&&2===e.type){for(var I=r(t.coor,2),m=r(I[0],2),S=(a=m[0],n=m[1],r(I[1],2)),x=(h=S[0],l=S[1],e.coor),M=0;M<x.length;M++){var b=r(x[M],2),E=b[0],H=b[1];if(E<a||E>h||H<n||H>l)return!1}return!0}if(2===t.type&&1===e.type){for(x=e.coor,M=0;M<x.length;M++){var T=r(x[M],2);if(!c(E=T[0],H=T[1],t.coor))return!1}return!0}if(2===t.type&&2===e.type){var k=t.coor,G=e.coor;for(M=0;M<G.length;M++){var w=r(G[M],2);if(!c(E=w[0],H=w[1],k))return!1}return!0}}(t,e)},p.prototype.drawRect=function(t,e){var i=this;if(2===t.coor.length){var s=t.strokeStyle,a=t.fillStyle,n=t.active,o=t.creating,h=t.coor,c=t.lineWidth,l=r(h.map((function(t){return t.map((function(t){return Math.round(t*i.scale)}))})),2),u=r(l[0],2),d=u[0],p=u[1],f=r(l[1],2),g=f[0],v=f[1];this.ctx.save(),this.ctx.lineWidth=c||this.lineWidth,this.ctx.fillStyle=n||o?this.activeFillStyle:a||this.fillStyle,this.ctx.strokeStyle=n||o?this.activeStrokeStyle:s||this.strokeStyle;var y=g-d,I=v-p;o||this.ctx.fillRect(d,p,y,I),this.ctx.strokeRect(d,p,y,I),this.ctx.restore();var m=[(h[1][0]+h[0][0])/2,(h[1][1]+h[0][1])/2];this.drawLabel(m,t)}},p.prototype.drawPolygon=function(t){var e=this,i=t.strokeStyle,s=t.fillStyle,a=t.active,n=t.creating,o=t.coor,h=t.lineWidth;if(this.ctx.save(),this.ctx.lineJoin="round",this.ctx.lineWidth=h||this.lineWidth,this.ctx.fillStyle=a||n?this.activeFillStyle:s||this.fillStyle,this.ctx.strokeStyle=a||n?this.activeStrokeStyle:i||this.strokeStyle,this.ctx.beginPath(),o.forEach((function(t,i){var s=r(t.map((function(t){return Math.round(t*e.scale)})),2),a=s[0],n=s[1];0===i?e.ctx.moveTo(a,n):e.ctx.lineTo(a,n)})),n){var c=r(this.mouse||[],2),l=c[0],u=c[1];this.ctx.lineTo(l-this.originX,u-this.originY)}else o.length>2&&this.ctx.closePath();this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(this.calculateCenter(o),t)},p.prototype.drawDot=function(t){var e=this;if(""===t.color){var i=t.strokeStyle,s=t.fillStyle,a=t.active,n=t.coor,o=t.lineWidth,h=r(n.map((function(t){return t*e.scale})),2),c=h[0],l=h[1];this.ctx.save(),this.ctx.lineWidth=o||this.lineWidth,this.ctx.fillStyle=a?this.activeFillStyle:s||this.ctrlFillStyle,this.ctx.strokeStyle=a?this.activeStrokeStyle:i||this.strokeStyle,this.ctx.beginPath(),this.ctx.arc(c,l,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(c,l,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(n,t)}else{var u=t.color,d=r((n=t.coor).map((function(t){return t*e.scale})),2);c=d[0],l=d[1];this.ctx.beginPath(),this.ctx.arc(c,l,3,0,2*Math.PI),this.ctx.fillStyle="rgba(255, 255, 255, 0.75)",this.ctx.fill(),this.ctx.strokeStyle=u,this.ctx.stroke()}},p.prototype.drawCirle=function(t){var e=this,i=t.strokeStyle,s=t.fillStyle,a=t.active,n=t.coor;t.label;var o=t.creating,h=t.radius;t.ctrlsData;var c=t.lineWidth,l=r(n.map((function(t){return t*e.scale})),2),u=l[0],d=l[1];this.ctx.save(),this.ctx.lineWidth=c||this.lineWidth,this.ctx.fillStyle=a||o?this.activeFillStyle:s||this.fillStyle,this.ctx.strokeStyle=a||o?this.activeStrokeStyle:i||this.strokeStyle,this.ctx.beginPath(),this.ctx.arc(u,d,h*this.scale,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(u,d,h*this.scale,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(t.coor,t)},p.prototype.drawLine=function(t){var e=this,i=t.strokeStyle,s=t.active,a=t.creating,n=t.coor,o=t.lineWidth;if(this.ctx.save(),this.ctx.lineJoin="round",this.ctx.lineWidth=o||this.lineWidth,this.ctx.strokeStyle=s||a?this.activeStrokeStyle:i||this.strokeStyle,this.ctx.beginPath(),n.forEach((function(t,i){var s=r(t.map((function(t){return Math.round(t*e.scale)})),2),a=s[0],n=s[1];0===i?e.ctx.moveTo(a,n):e.ctx.lineTo(a,n)})),a){var h=r(this.mouse||[],2),c=h[0],l=h[1];this.ctx.lineTo(c-this.originX,l-this.originY)}this.ctx.stroke(),this.ctx.restore(),this.drawLabel(n[0],t)},p.prototype.hexToRGBA=function(t,e){void 0===e&&(e=.7);var i=t.replace(/^#/,"");if(!/^[A-Fa-f0-9]{3}$/.test(i)&&!/^[A-Fa-f0-9]{6}$/.test(i))return t;3===i.length&&(i=i.split("").map((function(t){return t+t})).join(""));var s=parseInt(i.slice(0,2),16),a=parseInt(i.slice(2,4),16),n=parseInt(i.slice(4,6),16);return"rgba(".concat(s,", ").concat(a,", ").concat(n,", ").concat(e,")")},p.prototype.rgbaToHex=function(t,e){void 0===e&&(e=!1);var i=(t=t.trim().replace(/\s/g,"")).match(/(\d{1,3}),(\d{1,3}),(\d{1,3}),?(\d+(\.\d+)?)?/);if(!i)return t;var s=parseInt(i[1],10),a=parseInt(i[2],10),n=parseInt(i[3],10),r=i[4]?parseFloat(i[4]):1,o=s.toString(16).padStart(2,"0"),h=a.toString(16).padStart(2,"0"),c=n.toString(16).padStart(2,"0");if(e){var l=Math.round(255*r).toString(16).padStart(2,"0");return"#".concat(o).concat(h).concat(c).concat(l)}return"#".concat(o).concat(h).concat(c)},p.prototype.isRGBA=function(t){return/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(0(\.\d+)?|1(\.0+)?)\)$/.test(t)},p.prototype.removeDuplicatePoints=function(t,e,i){void 0===e&&(e=!1),void 0===i&&(i=!0);var s=new Set,a=[],n=t[0][0],r=t[0][0],o=t[0][1],h=t[0][1];return i?e?(t.forEach((function(t){var i="".concat(t[0],",").concat(t[1]);s.has(i)||(s.add(i),a.push(t)),e&&-1!==t[0]&&-1!==t[1]&&(n=Math.max(n,t[0]),o=Math.max(o,t[1]),r=Math.min(r,t[0]),h=Math.min(h,t[1]))})),this.activeShape.type===d.Brush?{resultCoor:a,resultRect:[r-this.brushlineWidth/2,h-this.brushlineWidth/2,n-r+this.brushlineWidth,o-h+this.brushlineWidth]}:{resultCoor:a,resultRect:[r,h,n-r,o-h]}):(t.forEach((function(t){var e="".concat(t[0],",").concat(t[1]);s.has(e)||(s.add(e),a.push(t))})),{resultCoor:a}):e?(t.forEach((function(t){-1!==t[0]&&-1!==t[1]&&(n=Math.max(n,t[0]),o=Math.max(o,t[1]),r=Math.min(r,t[0]),h=Math.min(h,t[1]))})),this.activeShape.type===d.Brush?{resultRect:[r-this.brushlineWidth/2,h-this.brushlineWidth/2,n-r+this.brushlineWidth,o-h+this.brushlineWidth]}:{resultRect:[r,h,n-r,o-h]}):void 0},p.prototype.drawBrush=function(t){var e=t.strokeStyle,i=t.active,s=t.creating,a=t.coor,n=t.lineWidth,r=t.iseraser;if(t.boundingRect,this.ctx.save(),this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.lineWidth=n||this.brushlineWidth,this.ctx.scale(this.scale,this.scale),a.length>1){if(r)this.ctx.strokeStyle="rgba(255, 0, 0, 1)",this.ctx.fillStyle="rgba(255, 0, 0, 1)",this.ctx.globalCompositeOperation="destination-out";else{var o=i||s?this.activeStrokeStyle:e||this.brushstrokeStyle;this.ctx.strokeStyle=o,this.ctx.fillStyle=o,this.ctx.globalCompositeOperation="source-over"}this.ctx.beginPath(),this.ctx.moveTo(a[0][0],a[0][1]);for(var h=1;h<a.length;h++)this.ctx.lineTo(a[h][0],a[h][1]);this.ctx.stroke()}this.ctx.restore()},p.prototype.drawGrid=function(t){var e=this;if(2===t.coor.length){var i=t.strokeStyle,s=t.fillStyle,a=t.active,n=t.creating,o=t.coor,h=t.lineWidth,c=r(o.map((function(t){return t.map((function(t){return Math.round(t*e.scale)}))})),2),l=r(c[0],2),u=l[0],d=l[1],p=r(c[1],2),f=p[0],g=p[1];this.ctx.save(),this.ctx.lineWidth=h||this.lineWidth,this.ctx.fillStyle=a||n?this.activeFillStyle:s||this.fillStyle,this.ctx.strokeStyle=a||n?this.activeStrokeStyle:i||this.strokeStyle,t.gridRects.forEach((function(i,s){var a;e.drawRect(i,{selectedFillStyle:t.selectedFillStyle||e.gridSelectedFillStyle,isSelected:null===(a=t.selected)||void 0===a?void 0:a.includes(s)})}));var v=f-u,y=g-d;n||this.ctx.fillRect(u,d,v,y),this.ctx.strokeRect(u,d,v,y),this.ctx.restore(),this.drawLabel(o[0],t)}},p.prototype.drawCtrl=function(t){var e=this,i=r(t.map((function(t){return t*e.scale})),2),s=i[0],a=i[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(s,a,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(s,a,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},p.prototype.drawCtrlList=function(t){var e=this;t.ctrlsData.forEach((function(i,s){t.type!==d.Polygon&&t.type!==d.Line||s!==e.ctrlIndex&&s!==e.clickIndex?(e.ctrlStrokeStyle="#000",e.ctrlRadius=3):(e.ctrlStrokeStyle="red",e.ctrlRadius=5),t.type===d.Circle?1===s&&e.drawCtrl(i):e.drawCtrl(i)}))},p.prototype.calculateCenter=function(t){if(0===t.length)throw new Error("Points array cannot be empty.");var e=t.reduce((function(t,e){var i=r(e,2),s=i[0],a=i[1];return t[0]+=s,t[1]+=a,t}),[0,0]);return[e[0]/t.length,e[1]/t.length]},p.prototype.putDataOnCanvas=function(t,e,i,s){void 0===s&&(s=!0);var a=t.getContext("2d",{willReadFrequently:!0});if(a){for(var n=a.getImageData(this.originX,this.originY,this.IMAGE_WIDTH,this.IMAGE_HEIGHT),r=n.data,o=i.match(/rgba?\((\d+), (\d+), (\d+)(?:, ([0-9.]+))?\)/),h=0;h<e.length;h+=1)r[e[h]]=parseInt(o[1],10),r[e[h]+1]=parseInt(o[2],10),r[e[h]+2]=parseInt(o[3],10),r[e[h]+3]=255*(void 0!==o[4]?parseFloat(o[4]):.5);return s&&a.putImageData(n,this.originX,this.originY),n}},p.prototype.highlightMask=function(t){var e="";if(t>-1){var i=this.dataset[t];e=i.fillStyle.replace(/rgba\((\d+), (\d+), (\d+), (\d+(\.\d+)?)\)/,(function(t,e,i,s,a){return"rgba(".concat(e,", ").concat(i,", ").concat(s,", 0.75)")})),i.fillStyle=e}else for(var s=0;s<this.dataset.length;s++)this.dataset[s].type===d.Mask&&(e=this.dataset[s].fillStyle.replace(/rgba\((\d+), (\d+), (\d+), (\d+(\.\d+)?)\)/,(function(t,e,i,s,a){return"rgba(".concat(e,", ").concat(i,", ").concat(s,", 0.5)")})),this.dataset[s].fillStyle=e);this.update()},p.prototype.changeMaskPolygon=function(t){var e=this;this.dataset.find((function(t){return t.uuid===e.activePolygon})).coor=this.getContourPointsOfColoredRegion(this.activeCanvasData,t),this.update()},p.prototype.endMagicTool=function(){this.manageDoneList(l(this.dataset))},p.prototype.drawMask=function(t){var e=this;if(0===t.pixels.length||t.height!==this.IMAGE_HEIGHT||t.weight!==this.IMAGE_WIDTH){var i=t.maskBase64,s=new Image;s.crossOrigin="Anonymous",s.src="data:image/png;base64,".concat(i);var a=this;s.onload=function(){if("everything"===t.maskType){if(h=a.getImagedataFromImageClass(s,"everything")){for(var i=a.ctx.getImageData(a.originX,a.originY,a.IMAGE_WIDTH,a.IMAGE_HEIGHT),n=i.data,r=0;r<h.length;r+=4)if(h[r]>0){var o=a.random_color[h[r]%a.random_color.length];n[r]=o.r,n[r+1]=o.g,n[r+2]=o.b,n[r+3]=e.mask_alpha}a.ctx.putImageData(i,a.originX,a.originY)}}else if("click"===t.maskType){var h,c=[];if(h=a.getImagedataFromImageClass(s,"magic")){for(r=0;r<h.length;r+=4)255===h[r]&&255===h[r+1]&&255===h[r+2]&&c.push(r);t.pixels=c,t.height=a.IMAGE_HEIGHT,t.weight=a.IMAGE_WIDTH,t.fillStyle=t.strokeStyle,t.canvasData=a.putDataOnCanvas(a.canvas,c,t.fillStyle)}else console.error("Failed to get pixel data from mask image")}}}else this.putDataOnCanvas(this.canvas,t.pixels,t.fillStyle)},p.prototype.addPoint=function(){var t=this.activeShape;if(0!==Object.keys(t).length&&this.clickIndex>-1&&!this.readonly){var e=r(this.activeShape.coor[this.clickIndex],2),i=e[0],s=e[1],a=Math.round(i+3),n=Math.round(s+3);t.coor.splice(this.clickIndex+1,0,[a,n]),this.clickIndex++,this.update(),this.manageDoneList(l(this.dataset))}},p.prototype.deletePoint=function(){var t=this.activeShape;0!==Object.keys(t).length&&t.coor.length>3&&this.clickIndex>-1&&!this.readonly&&(t.coor.splice(this.clickIndex,1),this.update(),this.manageDoneList(l(this.dataset)),this.clickIndex=-1)},p.prototype.drawPencil=function(t){var e=t.strokeStyle,i=t.fillStyle,s=t.active,a=t.creating,n=t.coor,r=t.lineWidth;if(this.ctx.save(),this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.lineWidth=r||this.pencillineWidth,this.ctx.strokeStyle=s||a?this.activeStrokeStyle:e||this.pencilstrokeStyle,this.ctx.fillStyle=s||a?this.activeFillStyle:i||this.pencilstrokeStyle,this.ctx.scale(this.scale,this.scale),n.length>1){var o=n.some((function(t){return-1===t[0]&&-1===t[1]})),h=n.filter((function(t){return!(-1===t[0]&&-1===t[1])}));if(h.length>1){this.ctx.globalCompositeOperation="source-over",this.ctx.beginPath(),this.ctx.moveTo(h[0][0],h[0][1]);for(var c=1;c<h.length;c++)this.ctx.lineTo(h[c][0],h[c][1]);o&&this.ctx.closePath()}this.ctx.stroke(),o&&(this.ctx.clip(),this.ctx.fill())}this.ctx.restore()},p.prototype.drawLabel=function(t,e){var i=this,s=e.label,a=void 0===s?"":s,n=e.labelFillStyle,o=void 0===n?"":n,h=e.labelFontFamily,c=void 0===h?"":h,l=e.textFillStyle,u=void 0===l?"":l,d=e.hideLabel,p=e.labelUp,f=e.lineWidth;if(e.coor,a.length&&!("boolean"==typeof d?d:this.hideLabel)){var g=4,v=4,y=a.length<=this.labelMaxLen?a:"".concat(a.slice(0,this.labelMaxLen),"..."),I=Math.pow(this.textscaleStep>=0?1.1:.9,Math.abs(this.textscaleStep));this.ctx.font="".concat(this.labelFontSize*I,"px ").concat(c||"sans-serif");var m=this.ctx.measureText(y),S=m.width+2*g,x=parseInt(this.ctx.font)-4+2*v,M=f||this.lineWidth,b="boolean"==typeof p?p:this.labelUp,E=this.IMAGE_ORIGIN_WIDTH-t[0]<S/this.scale,H=this.IMAGE_ORIGIN_HEIGHT-t[1]<x/this.scale,T=t[1]>x/this.scale,k=b?T:H;this.ctx.save(),this.ctx.fillStyle=o||this.labelFillStyle;var G=r(t.map((function(t){return t*i.scale})),2),w=G[0],D=G[1];[1,2,5].includes(e.type)&&(w-=S/2,D-=x/2);var P=E?w-m.width-g+M/2:w+M/2,_=k?D-x-M/2:D+M/2,W=S,A=x;this.ctx.fillRect(P,_,W,A),this.ctx.fillStyle=u||this.textFillStyle,this.ctx.textBaseline="middle";var C=P+(W-m.width)/2,L=_+A/2;this.ctx.fillText(y,C,L,W),this.ctx.restore()}},p.prototype.update=function(t,e){var i=this;void 0===t&&(t=!1),void 0===e&&(e=!1),window.cancelAnimationFrame(this.timer),e&&this.initZoom(),this.timer=window.requestAnimationFrame((function(){var e,s;if(i.ctx.save(),i.ctx.clearRect(0,0,i.WIDTH,i.HEIGHT),i.ctx.translate(i.originX,i.originY),i.IMAGE_WIDTH&&i.IMAGE_HEIGHT)if(t){for(var a=i.ctx.getImageData(0,0,i.IMAGE_WIDTH,i.IMAGE_HEIGHT),r=a.data,o=0;o<r.length;o+=4)r[o]=0,r[o+1]=0,r[o+2]=0,r[o+3]=255;i.ctx.putImageData(a,i.originX,i.originY)}else i.image.src.includes("undefined")||(1===i.imagealpha?i.ctx.drawImage(i.image,0,0,i.IMAGE_WIDTH,i.IMAGE_HEIGHT):(i.ctx.globalAlpha=i.imagealpha,i.ctx.drawImage(i.image,0,0,i.IMAGE_WIDTH,i.IMAGE_HEIGHT),i.ctx.globalAlpha=1));var h=i.focusMode?i.activeShape.type?[i.activeShape]:[]:i.dataset;for(o=0;o<h.length;o++){var c=h[o];if(!c.hiddening)switch(c.type){case d.Rect:i.drawRect(c);break;case d.Polygon:i.drawPolygon(c);break;case d.Dot:i.drawDot(c);break;case d.Line:i.drawLine(c);break;case d.Circle:i.drawCirle(c);break;case d.Grid:i.drawGrid(c);break;case d.Brush:i.drawBrush(c);break;case d.Mask:i.drawMask(c);break;case d.Pencil:i.drawPencil(c)}}if([d.Rect,d.Polygon,d.Line,d.Circle,d.Grid].includes(i.activeShape.type)&&!i.activeShape.hiddening&&i.drawCtrlList(i.activeShape),i.magicPoints.length)try{for(var l=n(i.magicPoints),u=l.next();!u.done;u=l.next()){var p=u.value;i.drawPromptPointOnClick(p,i.canvas)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(s=l.return)&&s.call(l)}finally{if(e)throw e.error}}i.ctx.restore(),i.emit("updated",i.dataset)}))},p.prototype.hideActiveShape=function(t){if(t){this.hideList.push(t);for(var e=0;e<this.dataset.length;e++)if(this.dataset[e].uuid===t){this.dataset[e].hiddening=!0,this.dataset[e].dragging=!1,this.dataset[e].active=!1;break}this.update()}},p.prototype.showHiddenShape=function(){if(this.hideList.length){for(var t=0;t<this.dataset.length;t++)this.dataset[t].uuid===this.hideList[this.hideList.length-1]?(this.dataset[t].hiddening=!1,this.dataset[t].active=!0):this.dataset[t].active=!1;this.hideList.pop(),this.update()}},p.prototype.deleteByIndex=function(t){var e=this.dataset.findIndex((function(e){return e.index===t}));e>-1&&(this.emit("delete",this.dataset[e]),this.dataset.splice(e,1),this.dataset.forEach((function(t,e){t.index=e})),this.update(),this.manageDoneList(l(this.dataset)))},p.prototype.updateLabelByIndex=function(t,e,i,s,a){var n=function(t){a.forEach((function(a){"label"===a?t.label=i:"tagId"===a?t.tagId=e:"strokeStyle"===a?t.strokeStyle=s:"textFillStyle"===a?t.textFillStyle=s:"fillStyle"===a&&(t.fillStyle=s)}))};-1!==t?(n(this.dataset[t]),this.dataset[t].type===d.Pencil&&this.emit("updateLabel",this.dataset[t])):0!==Object.keys(this.activeShape).length&&(n(this.activeShape),this.activeShape.type===d.Pencil&&this.emit("updateLabel",this.activeShape)),this.update(),this.manageDoneList(l(this.dataset))},p.prototype.deleteAllShape=function(){this.dataset=[],this.update(),this.manageDoneList(l(this.dataset))},p.prototype.copyByIndex=function(t){var e=this.dataset.findIndex((function(e){return e.index===t}));if(e>-1)if(this.activeShape.type===d.Rect){var s=(I=l(this.dataset[e])).coor[1][1]-I.coor[0][1],a=I.coor[1][0]-I.coor[0][0],n=r(this.mouse||[],2),c=n[0],u=n[1];if(!this.isPointInBackground(this.mouse))return;if(this.isPointInBackground([c+a*this.scale,u+s*this.scale]))I.coor[0]=[(c-this.originX)/this.scale,(u-this.originY)/this.scale],I.coor[1]=[(c-this.originX)/this.scale+a,(u-this.originY)/this.scale+s];else if(this.isPointInBackground([c-a*this.scale,u-s*this.scale]))I.coor[0]=[(c-this.originX)/this.scale-a,(u-this.originY)/this.scale-s],I.coor[1]=[(c-this.originX)/this.scale,(u-this.originY)/this.scale];else if(this.isPointInBackground([c+a*this.scale,u-s*this.scale]))I.coor[0]=[(c-this.originX)/this.scale,(u-this.originY)/this.scale-s],I.coor[1]=[(c-this.originX)/this.scale+a,(u-this.originY)/this.scale];else{if(!this.isPointInBackground([c-a*this.scale,u+s*this.scale]))return;I.coor[0]=[(c-this.originX)/this.scale-a,(u-this.originY)/this.scale],I.coor[1]=[(c-this.originX)/this.scale,(u-this.originY)/this.scale+s]}I.uuid=h(),this.dataset.push(I),this.dataset[e].active=!1,this.dataset.forEach((function(t,e){t.index=e})),this.update(),this.manageDoneList(l(this.dataset))}else{if(this.activeShape.type!==d.Dot){if(this.activeShape.type===d.Circle){I=new m(i(i({},this.dataset[e]),{coor:o([],r(this.dataset[e].coor),!1),radius:this.activeShape.radius}),this.dataset[e].index);var p=r(this.mouse||[],2);c=p[0],u=p[1];if(!this.isPointInBackground(this.mouse))return;I.coor[0]=(c-this.originX)/this.scale,I.coor[1]=(u-this.originY)/this.scale;var f=[c-I.radius,u],g=[c+I.radius,u],v=[c,u-I.radius],y=[c,u+I.radius];if(!this.isPointInBackground(f)&&(I.coor[0]=(c-this.originX)/this.scale+I.radius,I.coor[1]=(u-this.originY)/this.scale,!this.isPointInBackground(g)))return;if(!this.isPointInBackground(g)&&(I.coor[0]=(c-this.originX)/this.scale-I.radius,I.coor[1]=(u-this.originY)/this.scale,!this.isPointInBackground(f)))return;if(!this.isPointInBackground(v)&&(I.coor[0]=(c-this.originX)/this.scale,I.coor[1]=(u-this.originY)/this.scale+I.radius,!this.isPointInBackground(y)))return;if(!this.isPointInBackground(y)&&(I.coor[0]=(c-this.originX)/this.scale,I.coor[1]=(u-this.originY)/this.scale-I.radius,!this.isPointInBackground(v)))return;return I.uuid=h(),this.dataset.push(I),this.dataset[e].active=!1,this.dataset.forEach((function(t,e){t.index=e})),this.update(),void this.manageDoneList(l(this.dataset))}return this.activeShape.type===d.Line||this.activeShape.type===d.Polygon||this.activeShape.type===d.Grid?void 0:(this.activeShape.type,void d.None)}var I=l(this.dataset[e]),S=r(this.mouse||[],2),c=S[0],u=S[1];if(!this.isPointInBackground(this.mouse))return;I.coor[0]=(c-this.originX)/this.scale,I.coor[1]=(u-this.originY)/this.scale,I.coor[0]==this.dataset[e].coor[0]&&I.coor[1]==this.dataset[e].coor[1]&&(I.coor[0]+=2,I.coor[1]+=2),I.uuid=h(),this.dataset.push(I),this.dataset[e].active=!1,this.dataset.forEach((function(t,e){t.index=e})),this.update(),this.manageDoneList(l(this.dataset))}},p.prototype.calcStep=function(t){void 0===t&&(t=""),this.IMAGE_WIDTH<this.WIDTH&&this.IMAGE_HEIGHT<this.HEIGHT&&(""!==t&&"b"!==t||(this.setScale(!0,!1,!0),this.calcStep("b"))),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(""!==t&&"s"!==t||(this.setScale(!1,!1,!0),this.calcStep("s")))},p.prototype.setScale=function(t,e,i){if(void 0===e&&(e=!1),void 0===i&&(i=!1),!this.lock&&!(!t&&this.imageMin<this.MIN_LENGTH||t&&this.IMAGE_WIDTH>10*this.imageOriginMax)){t?this.scaleStep++:this.scaleStep--;var s=0,a=0,n=r(this.mouse||[],2),o=n[0],h=n[1];e&&(s=(o-this.originX)/this.scale,a=(h-this.originY)/this.scale);var c=Math.abs(this.scaleStep),l=this.IMAGE_WIDTH;if(this.IMAGE_WIDTH=Math.round(this.IMAGE_ORIGIN_WIDTH*Math.pow(this.scaleStep>=0?1.1:.9,c)),this.IMAGE_HEIGHT=Math.round(this.IMAGE_ORIGIN_HEIGHT*Math.pow(this.scaleStep>=0?1.1:.9,c)),e)this.originX=o-s*this.scale,this.originY=h-a*this.scale;else{var u=this.IMAGE_WIDTH/l;this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*u,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*u}this.emit("scale",{type:t,byMouse:e,pure:i}),i||this.update()}},p.prototype.fitZoom=function(){this.calcStep(),this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH)),this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2,this.textscaleStep=0,this.emit("fitZoom"),this.update()},p.prototype.initZoom=function(){this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT,this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2,this.textscaleStep=0},p.prototype.setFocusMode=function(t){this.focusMode=t,this.update()},p.prototype.manageDoneList=function(t){this.doneList.push(t),this.doneList.length>this.MAX_LENGTH&&this.doneList.shift()},p.prototype.undo=function(){if(this.doneList.length>1){this.clickIndex=-1;var t=this.doneList[this.doneList.length-1];this.undoList.push(t),this.doneList.pop();var e=l(this.doneList[this.doneList.length-1]);this.setData(e,!1)}},p.prototype.redo=function(){if(this.undoList.length>0){this.clickIndex=-1;var t=this.undoList[this.undoList.length-1];this.manageDoneList(t),this.undoList.pop();var e=l(this.doneList[this.doneList.length-1]);this.setData(e,!1)}},p.prototype.destroy=function(){this.canvas&&(this.image.removeEventListener("load",this.handleLoad),this.canvas.removeEventListener("contextmenu",this.handleContextmenu),this.canvas.removeEventListener("mousewheel",this.handleMousewheel),this.canvas.removeEventListener("wheel",this.handleMousewheel),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("touchstart",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("touchmove",this.handleMouseMove),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("touchend",this.handleMouseUp),this.canvas.removeEventListener("dblclick",this.handleDblclick),document.body.removeEventListener("keydown",this.handleKeydown,!0),document.body.removeEventListener("keyup",this.handleKeyup,!0),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width=null,this.canvas.style.height=null,this.canvas.style.userSelect=null)},p.prototype.resize=function(t,e,i,s){void 0===i&&(i=1),void 0===s&&(s=""),this.canvas.width=t,this.canvas.height=e,this.canvas.style.width=String(t)+"px",this.canvas.style.height=String(e)+"px",""===s&&void 0!==this.imagesrc||(this.imagesrc=s),this.setImage(this.imagesrc,i),this.initSetting(),this.update()},p}(y);return H}));
//# sourceMappingURL=canvas-select.min.js.map
